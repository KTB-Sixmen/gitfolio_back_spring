FROM amazoncorretto:17 AS runner
# Build arguments - 각 모듈별로 모든 필요한 환경변수를 ARG로 정의
# URL 관련 환경변수
ARG REDIRECT_ONBOARDING_URL
ARG REDIRECT_MAIN_URL
ARG MEMBER_SERVER_URL
ARG PAYMENT_SERVER_URL
ARG NOTIFICATION_SERVER_URL
ARG AI_SERVER_URL
ARG PAYMENT_SUCCESS_REDIRECT_URL

# gRPC 관련 환경변수
ARG MEMBER_GRPC_PORT

# 서버 포트 환경변수
ARG AUTH_SERVER_PORT
ARG MEMBER_SERVER_PORT
ARG RESUME_SERVER_PORT
ARG PAYMENT_SERVER_PORT
ARG NOTIFICATION_SERVER_PORT
ARG CHAT_SERVER_PORT

# GitHub OAuth 관련 환경변수
ARG GH_CLIENT_ID
ARG GH_CLIENT_SECRET
ARG GH_REDIRECT_URI
ARG GH_API_TOKEN

# JWT 관련 환경변수
ARG JWT_SECRET_KEY
ARG ACCESS_TOKEN_EXPIRY
ARG REFRESH_TOKEN_EXPIRY

# Redis 관련 환경변수
ARG AUTH_REDIS_HOST
ARG AUTH_REDIS_PORT
ARG RESUME_REDIS_HOST
ARG RESUME_REDIS_PORT

# MySQL 관련 환경변수
ARG MEMBER_MYSQL_DB_HOST
ARG MEMBER_MYSQL_DB_PORT
ARG MEMBER_MYSQL_DB_NAME
ARG MEMBER_MYSQL_DB_PASSWORD
ARG MEMBER_MYSQL_DB_USERNAME

ARG LIKE_MYSQL_DB_HOST
ARG LIKE_MYSQL_DB_PORT
ARG LIKE_MYSQL_DB_NAME
ARG LIKE_MYSQL_DB_PASSWORD
ARG LIKE_MYSQL_DB_USERNAME

ARG PAYMENT_MYSQL_DB_HOST
ARG PAYMENT_MYSQL_DB_PORT
ARG PAYMENT_MYSQL_DB_NAME
ARG PAYMENT_MYSQL_DB_PASSWORD
ARG PAYMENT_MYSQL_DB_USERNAME

ARG NOTIFICATION_MYSQL_DB_HOST
ARG NOTIFICATION_MYSQL_DB_PORT
ARG NOTIFICATION_MYSQL_DB_NAME
ARG NOTIFICATION_MYSQL_DB_PASSWORD
ARG NOTIFICATION_MYSQL_DB_USERNAME

# MongoDB 관련 환경변수
ARG MEMBER_MONGO_DB_URI
ARG RESUME_MONGO_DB_URI
ARG CHAT_MONGO_DB_URI

# S3 관련 환경변수
ARG S3_ACCESS_KEY
ARG S3_SECRET_KEY
ARG S3_URL_PREFIX

# Kakao Pay 관련 환경변수
ARG KAKAO_API_URL
ARG KAKAOPAY_SECRET_KEY

# Kafka 관련 환경변수
ARG KAFKA_HOST1
ARG KAFKA_PORT1
ARG KAFKA_BROKER_ID
ARG KAFKA_ZOOKEEPER_CONNECT
ARG KAFKA_LISTENER_DOCKER
ARG KAFKA_LISTENER_EXTERNAL
ARG KAFKA_ADVERTISED_LISTENER_DOCKER
ARG KAFKA_ADVERTISED_LISTENER_EXTERNAL
ARG KAFKA_INTER_BROKER_LISTENER_NAME
ARG KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR

# ENV로 모든 환경변수 설정 - ARG의 값을 ENV로 복사
ENV REDIRECT_ONBOARDING_URL=${REDIRECT_ONBOARDING_URL} \
   REDIRECT_MAIN_URL=${REDIRECT_MAIN_URL} \
   MEMBER_SERVER_URL=${MEMBER_SERVER_URL} \
   PAYMENT_SERVER_URL=${PAYMENT_SERVER_URL} \
   NOTIFICATION_SERVER_URL=${NOTIFICATION_SERVER_URL} \
   AI_SERVER_URL=${AI_SERVER_URL} \
   PAYMENT_SUCCESS_REDIRECT_URL=${PAYMENT_SUCCESS_REDIRECT_URL} \
   MEMBER_GRPC_PORT=${MEMBER_GRPC_PORT} \
   AUTH_SERVER_PORT=${AUTH_SERVER_PORT} \
   MEMBER_SERVER_PORT=${MEMBER_SERVER_PORT} \
   RESUME_SERVER_PORT=${RESUME_SERVER_PORT} \
   PAYMENT_SERVER_PORT=${PAYMENT_SERVER_PORT} \
   NOTIFICATION_SERVER_PORT=${NOTIFICATION_SERVER_PORT} \
   CHAT_SERVER_PORT=${CHAT_SERVER_PORT} \
   GH_CLIENT_ID=${GH_CLIENT_ID} \
   GH_CLIENT_SECRET=${GH_CLIENT_SECRET} \
   GH_REDIRECT_URI=${GH_REDIRECT_URI} \
   GH_API_TOKEN=${GH_API_TOKEN} \
   JWT_SECRET_KEY=${JWT_SECRET_KEY} \
   ACCESS_TOKEN_EXPIRY=${ACCESS_TOKEN_EXPIRY} \
   REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY} \
   AUTH_REDIS_HOST=${AUTH_REDIS_HOST} \
   AUTH_REDIS_PORT=${AUTH_REDIS_PORT} \
   RESUME_REDIS_HOST=${RESUME_REDIS_HOST} \
   RESUME_REDIS_PORT=${RESUME_REDIS_PORT} \
   MEMBER_MYSQL_DB_HOST=${MEMBER_MYSQL_DB_HOST} \
   MEMBER_MYSQL_DB_PORT=${MEMBER_MYSQL_DB_PORT} \
   MEMBER_MYSQL_DB_NAME=${MEMBER_MYSQL_DB_NAME} \
   MEMBER_MYSQL_DB_PASSWORD=${MEMBER_MYSQL_DB_PASSWORD} \
   MEMBER_MYSQL_DB_USERNAME=${MEMBER_MYSQL_DB_USERNAME} \
   LIKE_MYSQL_DB_HOST=${LIKE_MYSQL_DB_HOST} \
   LIKE_MYSQL_DB_PORT=${LIKE_MYSQL_DB_PORT} \
   LIKE_MYSQL_DB_NAME=${LIKE_MYSQL_DB_NAME} \
   LIKE_MYSQL_DB_PASSWORD=${LIKE_MYSQL_DB_PASSWORD} \
   LIKE_MYSQL_DB_USERNAME=${LIKE_MYSQL_DB_USERNAME} \
   PAYMENT_MYSQL_DB_HOST=${PAYMENT_MYSQL_DB_HOST} \
   PAYMENT_MYSQL_DB_PORT=${PAYMENT_MYSQL_DB_PORT} \
   PAYMENT_MYSQL_DB_NAME=${PAYMENT_MYSQL_DB_NAME} \
   PAYMENT_MYSQL_DB_PASSWORD=${PAYMENT_MYSQL_DB_PASSWORD} \
   PAYMENT_MYSQL_DB_USERNAME=${PAYMENT_MYSQL_DB_USERNAME} \
   NOTIFICATION_MYSQL_DB_HOST=${NOTIFICATION_MYSQL_DB_HOST} \
   NOTIFICATION_MYSQL_DB_PORT=${NOTIFICATION_MYSQL_DB_PORT} \
   NOTIFICATION_MYSQL_DB_NAME=${NOTIFICATION_MYSQL_DB_NAME} \
   NOTIFICATION_MYSQL_DB_PASSWORD=${NOTIFICATION_MYSQL_DB_PASSWORD} \
   NOTIFICATION_MYSQL_DB_USERNAME=${NOTIFICATION_MYSQL_DB_USERNAME} \
   MEMBER_MONGO_DB_URI=${MEMBER_MONGO_DB_URI} \
   RESUME_MONGO_DB_URI=${RESUME_MONGO_DB_URI} \
   CHAT_MONGO_DB_URI=${CHAT_MONGO_DB_URI} \
   S3_ACCESS_KEY=${S3_ACCESS_KEY} \
   S3_SECRET_KEY=${S3_SECRET_KEY} \
   S3_URL_PREFIX=${S3_URL_PREFIX} \
   KAKAO_API_URL=${KAKAO_API_URL} \
   KAKAOPAY_SECRET_KEY=${KAKAOPAY_SECRET_KEY} \
   KAFKA_HOST1=${KAFKA_HOST1} \
   KAFKA_PORT1=${KAFKA_PORT1} \
   KAFKA_BROKER_ID=${KAFKA_BROKER_ID} \
   KAFKA_ZOOKEEPER_CONNECT=${KAFKA_ZOOKEEPER_CONNECT} \
   KAFKA_LISTENER_DOCKER=${KAFKA_LISTENER_DOCKER} \
   KAFKA_LISTENER_EXTERNAL=${KAFKA_LISTENER_EXTERNAL} \
   KAFKA_ADVERTISED_LISTENER_DOCKER=${KAFKA_ADVERTISED_LISTENER_DOCKER} \
   KAFKA_ADVERTISED_LISTENER_EXTERNAL=${KAFKA_ADVERTISED_LISTENER_EXTERNAL} \
   KAFKA_INTER_BROKER_LISTENER_NAME=${KAFKA_INTER_BROKER_LISTENER_NAME} \
   KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}

WORKDIR /auth
EXPOSE 8080

# 빌더 스테이지에서 파일 복사
COPY --from=builder:prod /gitfolio_back/build/.env .env
COPY --from=builder:prod /gitfolio_back/build/*-auth-*-SNAPSHOT.jar auth.jar
RUN chmod 644 .env

# 디버깅을 포함한 실행 명령
CMD [ "sh", "-c", \
      "echo '=== Checking .env file ===' && \
       ls -la .env && \
       echo '=== .env contents ===' && \
       cat .env && \
       echo '=== Starting application ===' && \
       java -jar auth.jar \
       --debug \
       --logging.level.org.springframework.core.env=TRACE \
       --spring.config.location=file:.env,classpath:/application.yml \
       --spring.config.import=optional:file:.env[.properties]" ]
