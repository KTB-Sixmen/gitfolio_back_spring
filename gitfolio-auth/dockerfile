FROM amazoncorretto:17 AS runner

WORKDIR /auth

# 빌드 시 전달받을 ARG 선언
ARG REDIRECT_ONBOARDING_URL
ARG REDIRECT_MAIN_URL
ARG MEMBER_SERVER_URL
ARG PAYMENT_SERVER_URL
ARG AI_SERVER_URL

ARG MEMBER_GRPC_PORT

ARG AUTH_SERVER_PORT
ARG MEMBER_SERVER_PORT
ARG RESUME_SERVER_PORT
ARG PAYMENT_SERVER_PORT
ARG NOTIFICATION_SERVER_PORT
ARG CHAT_SERVER_PORT

ARG GH_CLIENT_ID
ARG GH_CLIENT_SECRET
ARG GH_REDIRECT_URI

ARG GH_API_TOKEN

ARG JWT_SECRET_KEY
ARG ACCESS_TOKEN_EXPIRY
ARG REFRESH_TOKEN_EXPIRY

ARG AUTH_REDIS_HOST
ARG AUTH_REDIS_PORT

ARG RESUME_REDIS_HOST
ARG RESUME_REDIS_PORT

ARG MEMBER_MYSQL_DB_HOST
ARG MEMBER_MYSQL_DB_PORT
ARG MEMBER_MYSQL_DB_NAME
ARG MEMBER_MYSQL_DB_PASSWORD
ARG MEMBER_MYSQL_DB_USERNAME

ARG LIKE_MYSQL_DB_HOST
ARG LIKE_MYSQL_DB_PORT
ARG LIKE_MYSQL_DB_NAME
ARG LIKE_MYSQL_DB_PASSWORD
ARG LIKE_MYSQL_DB_USERNAME

ARG PAYMENT_MYSQL_DB_HOST
ARG PAYMENT_MYSQL_DB_PORT
ARG PAYMENT_MYSQL_DB_NAME
ARG PAYMENT_MYSQL_DB_PASSWORD
ARG PAYMENT_MYSQL_DB_USERNAME

ARG NOTIFICATION_MYSQL_DB_HOST
ARG NOTIFICATION_MYSQL_DB_PORT
ARG NOTIFICATION_MYSQL_DB_NAME
ARG NOTIFICATION_MYSQL_DB_PASSWORD
ARG NOTIFICATION_MYSQL_DB_USERNAME

ARG MEMBER_MONGO_DB_USERNAME
ARG MEMBER_MONGO_DB_PORT
ARG MEMBER_MONGO_DB_DATABASE

ARG RESUME_MONGO_DB_USERNAME
ARG RESUME_MONGO_DB_PORT
ARG RESUME_MONGO_DB_DATABASE

ARG CHAT_MONGO_DB_USERNAME
ARG CHAT_MONGO_DB_PORT
ARG CHAT_MONGO_DB_DATABASE

ARG S3_ACCESS_KEY
ARG S3_SECRET_KEY
ARG S3_URL_PREFIX

ARG KAKAO_API_URL
ARG KAKAOPAY_SECRET_KEY

ARG KAFKA_HOST1
ARG KAFKA_PORT1

# 환경 변수 설정
ENV REDIRECT_ONBOARDING_URL=${REDIRECT_ONBOARDING_URL} \
    REDIRECT_MAIN_URL=${REDIRECT_MAIN_URL} \
    MEMBER_SERVER_URL=${MEMBER_SERVER_URL} \
    PAYMENT_SERVER_URL=${PAYMENT_SERVER_URL} \
    AI_SERVER_URL=${AI_SERVER_URL} \
    MEMBER_GRPC_PORT=${MEMBER_GRPC_PORT} \
    AUTH_SERVER_PORT=${AUTH_SERVER_PORT} \
    MEMBER_SERVER_PORT=${MEMBER_SERVER_PORT} \
    RESUME_SERVER_PORT=${RESUME_SERVER_PORT} \
    PAYMENT_SERVER_PORT=${PAYMENT_SERVER_PORT} \
    NOTIFICATION_SERVER_PORT=${NOTIFICATION_SERVER_PORT} \
    CHAT_SERVER_PORT=${CHAT_SERVER_PORT} \
    GH_CLIENT_ID=${GH_CLIENT_ID} \
    GH_CLIENT_SECRET=${GH_CLIENT_SECRET} \
    GH_REDIRECT_URI=${GH_REDIRECT_URI} \
    GH_API_TOKEN=${GH_API_TOKEN} \
    JWT_SECRET_KEY=${JWT_SECRET_KEY} \
    ACCESS_TOKEN_EXPIRY=${ACCESS_TOKEN_EXPIRY} \
    REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY} \
    AUTH_REDIS_HOST=${AUTH_REDIS_HOST} \
    AUTH_REDIS_PORT=${AUTH_REDIS_PORT} \
    RESUME_REDIS_HOST=${RESUME_REDIS_HOST} \
    RESUME_REDIS_PORT=${RESUME_REDIS_PORT} \
    MEMBER_MYSQL_DB_HOST=${MEMBER_MYSQL_DB_HOST} \
    MEMBER_MYSQL_DB_PORT=${MEMBER_MYSQL_DB_PORT} \
    MEMBER_MYSQL_DB_NAME=${MEMBER_MYSQL_DB_NAME} \
    MEMBER_MYSQL_DB_PASSWORD=${MEMBER_MYSQL_DB_PASSWORD} \
    MEMBER_MYSQL_DB_USERNAME=${MEMBER_MYSQL_DB_USERNAME} \
    LIKE_MYSQL_DB_HOST=${LIKE_MYSQL_DB_HOST} \
    LIKE_MYSQL_DB_PORT=${LIKE_MYSQL_DB_PORT} \
    LIKE_MYSQL_DB_NAME=${LIKE_MYSQL_DB_NAME} \
    LIKE_MYSQL_DB_PASSWORD=${LIKE_MYSQL_DB_PASSWORD} \
    LIKE_MYSQL_DB_USERNAME=${LIKE_MYSQL_DB_USERNAME} \
    PAYMENT_MYSQL_DB_HOST=${PAYMENT_MYSQL_DB_HOST} \
    PAYMENT_MYSQL_DB_PORT=${PAYMENT_MYSQL_DB_PORT} \
    PAYMENT_MYSQL_DB_NAME=${PAYMENT_MYSQL_DB_NAME} \
    PAYMENT_MYSQL_DB_PASSWORD=${PAYMENT_MYSQL_DB_PASSWORD} \
    PAYMENT_MYSQL_DB_USERNAME=${PAYMENT_MYSQL_DB_USERNAME} \
    NOTIFICATION_MYSQL_DB_HOST=${NOTIFICATION_MYSQL_DB_HOST} \
    NOTIFICATION_MYSQL_DB_PORT=${NOTIFICATION_MYSQL_DB_PORT} \
    NOTIFICATION_MYSQL_DB_NAME=${NOTIFICATION_MYSQL_DB_NAME} \
    NOTIFICATION_MYSQL_DB_PASSWORD=${NOTIFICATION_MYSQL_DB_PASSWORD} \
    NOTIFICATION_MYSQL_DB_USERNAME=${NOTIFICATION_MYSQL_DB_USERNAME} \
    MEMBER_MONGO_DB_USERNAME=${MEMBER_MONGO_DB_USERNAME} \
    MEMBER_MONGO_DB_PORT=${MEMBER_MONGO_DB_PORT} \
    MEMBER_MONGO_DB_DATABASE=${MEMBER_MONGO_DB_DATABASE} \
    RESUME_MONGO_DB_USERNAME=${RESUME_MONGO_DB_USERNAME} \
    RESUME_MONGO_DB_PORT=${RESUME_MONGO_DB_PORT} \
    RESUME_MONGO_DB_DATABASE=${RESUME_MONGO_DB_DATABASE} \
    CHAT_MONGO_DB_USERNAME=${CHAT_MONGO_DB_USERNAME} \
    CHAT_MONGO_DB_PORT=${CHAT_MONGO_DB_PORT} \
    CHAT_MONGO_DB_DATABASE=${CHAT_MONGO_DB_DATABASE} \
    S3_ACCESS_KEY=${S3_ACCESS_KEY} \
    S3_SECRET_KEY=${S3_SECRET_KEY} \
    S3_URL_PREFIX=${S3_URL_PREFIX} \
    KAKAO_API_URL=${KAKAO_API_URL} \
    KAKAOPAY_SECRET_KEY=${KAKAOPAY_SECRET_KEY} \
    KAFKA_HOST1=${KAFKA_HOST1} \
    KAFKA_PORT1=${KAFKA_PORT1}

EXPOSE 8080

# COPY --from=aida0/gitfolio_builder:test /gitfolio_back/build/.env .env
COPY --from=aida0/gitfolio_builder:test /gitfolio_back/build/*-auth-*-SNAPSHOT.jar auth.jar

CMD [ "java", "-jar", "auth.jar" ]